<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobber Reconciler Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Jobber Expense Reconciler</h1>

        <!-- Step 1: Bank File -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="font-semibold text-lg mb-2">Step 1: Bank Transactions</h2>
            <p class="text-gray-500 text-sm mb-4">Upload your bank or credit card statement (CSV)</p>
            <input type="file" id="bankFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="loadBank(this)">
            <div id="bankStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- Step 2: Jobber File -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="font-semibold text-lg mb-2">Step 2: Jobber Expenses</h2>
            <p class="text-gray-500 text-sm mb-4">Upload your Jobber expense report (CSV)</p>
            <input type="file" id="jobberFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" onchange="loadJobber(this)">
            <div id="jobberStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- Step 3: Employees (hidden until files loaded) -->
        <div id="employeeSection" class="bg-white rounded-lg shadow mb-4 hidden">
            <div class="p-4 cursor-pointer hover:bg-gray-100 transition select-none" onclick="toggleEmployeeSection()">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i id="employeeToggleIcon" class="fas fa-chevron-down text-gray-400 transition-transform duration-200" style="transform: rotate(-90deg);"></i>
                        <div>
                            <h2 class="font-semibold text-lg">Employees Detected</h2>
                            <p class="text-gray-500 text-sm" id="employeeCount">0 employees</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400 hidden" id="expandHint">Click to expand</span>
                        <button onclick="event.stopPropagation(); addNewEmployee()" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">+ Add</button>
                    </div>
                </div>
            </div>
            <div id="employeeContent" class="px-4 pb-4 hidden">
                <p class="text-gray-500 text-sm mb-3">Add phone numbers for SMS receipt requests</p>
                <div id="employeeList" class="space-y-2"></div>
            </div>
        </div>

        <!-- Step 4: Match Button -->
        <div id="matchSection" class="hidden mb-4">
            <button onclick="runMatch()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transform transition hover:scale-[1.02]">
                <i class="fas fa-sync-alt mr-2"></i>Match Transactions
            </button>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-4">
                <h2 class="font-semibold text-lg mb-4">Results</h2>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-green-100 rounded-lg">
                        <p class="text-2xl font-bold text-green-700" id="countMatched">0</p>
                        <p class="text-xs text-green-600">Matched</p>
                    </div>
                    <div class="text-center p-3 bg-yellow-100 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-700" id="countPartial">0</p>
                        <p class="text-xs text-yellow-600">Partial</p>
                    </div>
                    <div class="text-center p-3 bg-red-100 rounded-lg">
                        <p class="text-2xl font-bold text-red-700" id="countMissing">0</p>
                        <p class="text-xs text-red-600">Missing</p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <div class="flex justify-between items-center mb-3 cursor-pointer" onclick="toggleFilters()">
                    <h3 class="font-semibold text-gray-700"><i class="fas fa-filter mr-2"></i>Filters</h3>
                    <i id="filterToggleIcon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                </div>
                <div id="filterContent" class="hidden space-y-3">
                    <!-- Match Status Filter -->
                    <div>
                        <label class="text-sm font-medium text-gray-600">Match Status</label>
                        <div class="flex gap-2 mt-1 flex-wrap">
                            <button onclick="setFilter('status', 'all')" class="filter-btn px-3 py-1 rounded-full text-sm bg-blue-500 text-white" data-filter="status" data-value="all">All</button>
                            <button onclick="setFilter('status', 'exact')" class="filter-btn px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="status" data-value="exact">✓ Exact</button>
                            <button onclick="setFilter('status', 'partial')" class="filter-btn px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="status" data-value="partial">~ Close</button>
                            <button onclick="setFilter('status', 'none')" class="filter-btn px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter="status" data-value="none">✗ Missing</button>
                        </div>
                    </div>
                    
                    <!-- Employee Filter -->
                    <div>
                        <label class="text-sm font-medium text-gray-600">Employee</label>
                        <select id="filterEmployee" onchange="setFilter('employee', this.value)" class="w-full mt-1 p-2 border rounded text-sm">
                            <option value="all">All Employees</option>
                        </select>
                    </div>
                    
                    <!-- Job Filter -->
                    <div>
                        <label class="text-sm font-medium text-gray-600">Job #</label>
                        <select id="filterJob" onchange="setFilter('job', this.value)" class="w-full mt-1 p-2 border rounded text-sm">
                            <option value="all">All Jobs</option>
                        </select>
                    </div>
                    
                    <!-- Amount Range -->
                    <div>
                        <label class="text-sm font-medium text-gray-600">Amount Range</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" id="filterMinAmount" placeholder="Min $" class="w-1/2 p-2 border rounded text-sm" onchange="setFilter('amountMin', this.value)">
                            <input type="number" id="filterMaxAmount" placeholder="Max $" class="w-1/2 p-2 border rounded text-sm" onchange="setFilter('amountMax', this.value)">
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div>
                        <label class="text-sm font-medium text-gray-600">Date Range</label>
                        <div class="flex gap-2 mt-1">
                            <input type="date" id="filterDateFrom" class="w-1/2 p-2 border rounded text-sm" onchange="setFilter('dateFrom', this.value)">
                            <input type="date" id="filterDateTo" class="w-1/2 p-2 border rounded text-sm" onchange="setFilter('dateTo', this.value)">
                        </div>
                    </div>
                    
                    <button onclick="clearFilters()" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm text-gray-700">
                        <i class="fas fa-times mr-1"></i>Clear All Filters
                    </button>
                </div>
            </div>
            
            <div id="transactionsList" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // Data
        let bankTxns = [];
        let jobberExps = [];
        let employees = {}; // name -> {name, phone, sources: []}
        let matchResults = []; // Store all match results
        let currentFilters = {
            status: 'all',
            employee: 'all',
            job: 'all',
            amountMin: '',
            amountMax: '',
            dateFrom: '',
            dateTo: ''
        };
        
        // Load saved phone numbers from localStorage
        const savedPhones = JSON.parse(localStorage.getItem('jobberPhones') || '{}');
        
        // Toggle filters section
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const icon = document.getElementById('filterToggleIcon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        
        // Set filter value
        function setFilter(type, value) {
            currentFilters[type] = value;
            
            // Update button styles for status filter
            if (type === 'status') {
                document.querySelectorAll('[data-filter="status"]').forEach(btn => {
                    if (btn.dataset.value === value) {
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                        btn.classList.add('bg-blue-500', 'text-white');
                    } else {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    }
                });
            }
            
            applyFilters();
        }
        
        // Apply filters and re-render
        function applyFilters() {
            if (!matchResults.length) return;
            
            const filtered = matchResults.filter(r => {
                // Status filter
                if (currentFilters.status !== 'all' && r.status !== currentFilters.status) {
                    return false;
                }
                
                // Employee filter
                if (currentFilters.employee !== 'all') {
                    const emp = r.bank.cardholder;
                    if (emp !== currentFilters.employee) return false;
                }
                
                // Job filter
                if (currentFilters.job !== 'all') {
                    if (!r.match || r.match.job !== currentFilters.job) return false;
                }
                
                // Amount range
                const amt = r.bank.amount;
                if (currentFilters.amountMin && amt < parseFloat(currentFilters.amountMin)) return false;
                if (currentFilters.amountMax && amt > parseFloat(currentFilters.amountMax)) return false;
                
                // Date range (basic string comparison for now)
                if (currentFilters.dateFrom && r.bank.date && r.bank.date < currentFilters.dateFrom) return false;
                if (currentFilters.dateTo && r.bank.date && r.bank.date > currentFilters.dateTo) return false;
                
                return true;
            });
            
            renderFilteredResults(filtered);
            
            // Update counts
            const matched = filtered.filter(r => r.status === 'exact').length;
            const partial = filtered.filter(r => r.status === 'partial').length;
            const missing = filtered.filter(r => r.status === 'none').length;
            document.getElementById('countMatched').textContent = matched;
            document.getElementById('countPartial').textContent = partial;
            document.getElementById('countMissing').textContent = missing;
        }
        
        // Clear all filters
        function clearFilters() {
            currentFilters = {
                status: 'all',
                employee: 'all',
                job: 'all',
                amountMin: '',
                amountMax: '',
                dateFrom: '',
                dateTo: ''
            };
            
            // Reset UI
            document.getElementById('filterEmployee').value = 'all';
            document.getElementById('filterJob').value = 'all';
            document.getElementById('filterMinAmount').value = '';
            document.getElementById('filterMaxAmount').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            setFilter('status', 'all');
            applyFilters();
        }
        
        // Toggle employee section
        function toggleEmployeeSection() {
            console.log('Toggle clicked');
            const content = document.getElementById('employeeContent');
            const icon = document.getElementById('employeeToggleIcon');
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
            }
            console.log('Content visible:', !content.classList.contains('hidden'));
        }

        // Load Bank CSV
        function loadBank(input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('bankStatus');
            status.innerHTML = '<span class="text-blue-600">Reading...</span>';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    bankTxns = results.data
                        .filter(row => row.Amount && parseFloat(row.Amount) !== 0)
                        .map(row => ({
                            date: row.Date || '',
                            merchant: row.Merchant || row.Description || '',
                            amount: Math.abs(parseFloat(row.Amount)),
                            cardholder: row['Name on card'] || row.Cardholder || '',
                            raw: row
                        }));

                    status.innerHTML = `<span class="text-green-600">✓ ${bankTxns.length} transactions loaded</span>`;
                    extractEmployees();
                    checkReady();
                },
                error: function(err) {
                    status.innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
                }
            });
        }

        // Load Jobber CSV
        function loadJobber(input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('jobberStatus');
            status.innerHTML = '<span class="text-blue-600">Reading...</span>';

            const reader = new FileReader();
            reader.onload = function(e) {
                let text = e.target.result;
                const lines = text.split('\n');
                
                // Find header row
                let headerIdx = 0;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Item name')) {
                        headerIdx = i;
                        break;
                    }
                }

                // Parse from header
                const cleanText = lines.slice(headerIdx).join('\n');
                
                Papa.parse(cleanText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        jobberExps = results.data
                            .filter(row => row['Total $'])
                            .map(row => {
                                const amtStr = String(row['Total $']).replace(/,/g, '').replace(/"/g, '');
                                return {
                                    item: row['Item name'] || '',
                                    amount: parseFloat(amtStr) || 0,
                                    employee: row['Entered by'] || '',
                                    job: row['Job #'] || '',
                                    date: row.Date || '',
                                    raw: row
                                };
                            })
                            .filter(x => x.amount > 0);

                        status.innerHTML = `<span class="text-green-600">✓ ${jobberExps.length} expenses loaded</span>`;
                        extractEmployees();
                        checkReady();
                    },
                    error: function(err) {
                        status.innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
                    }
                });
            };
            reader.readAsText(file);
        }

        // Extract unique employees from both files
        function extractEmployees() {
            // From Jobber - use "Entered by" field
            jobberExps.forEach(exp => {
                if (exp.employee && exp.employee !== 'N/A') {
                    const name = exp.employee.trim();
                    if (!employees[name]) {
                        employees[name] = { name, phone: '', sources: ['jobber'] };
                    }
                }
            });

            // From Bank - use "Name on card" field
            bankTxns.forEach(tx => {
                if (tx.cardholder) {
                    const name = tx.cardholder.trim();
                    if (!employees[name]) {
                        employees[name] = { name, phone: '', sources: ['bank'] };
                    } else if (!employees[name].sources.includes('bank')) {
                        employees[name].sources.push('bank');
                    }
                }
            });

            renderEmployees();
        }

        // Render employee list
        function renderEmployees() {
            const empList = Object.values(employees);
            if (empList.length === 0) return;

            document.getElementById('employeeSection').classList.remove('hidden');
            document.getElementById('employeeCount').textContent = `${empList.length} employee${empList.length !== 1 ? 's' : ''}`;
            
            // Merge saved phones
            empList.forEach(emp => {
                if (savedPhones[emp.name]) {
                    emp.phone = savedPhones[emp.name];
                }
            });
            
            const container = document.getElementById('employeeList');
            
            container.innerHTML = empList.map((emp) => `
                <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg text-sm">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${emp.name}</p>
                        <p class="text-xs text-gray-500">${emp.sources.join(', ')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-phone text-gray-400 text-xs"></i>
                        <input type="tel" 
                            value="${emp.phone}" 
                            placeholder="Phone"
                            onchange="updatePhone('${emp.name}', this.value)"
                            class="w-32 px-2 py-1 border rounded text-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            `).join('');
        }

        // Update phone and save to localStorage
        function updatePhone(name, phone) {
            console.log('Saving phone for', name, ':', phone);
            if (employees[name]) {
                employees[name].phone = phone;
                savedPhones[name] = phone;
                localStorage.setItem('jobberPhones', JSON.stringify(savedPhones));
                
                // Visual feedback
                const input = event.target;
                input.classList.add('bg-green-50');
                setTimeout(() => input.classList.remove('bg-green-50'), 500);
            }
        }

        // Add new employee manually
        function addNewEmployee() {
            const name = prompt('Enter employee name:');
            if (name && name.trim()) {
                employees[name.trim()] = { 
                    name: name.trim(), 
                    phone: '', 
                    sources: ['manual'] 
                };
                renderEmployees();
            }
        }

        // Check if ready to match
        function checkReady() {
            if (bankTxns.length > 0 && jobberExps.length > 0) {
                document.getElementById('matchSection').classList.remove('hidden');
            }
        }

        // Run matching
        function runMatch() {
            console.log('Matching', bankTxns.length, 'bank txns to', jobberExps.length, 'jobber expenses');
            
            const results = [];
            const matchedJobber = new Set();

            // For each bank transaction, find best match
            for (const bank of bankTxns) {
                let bestMatch = null;
                let bestScore = 0;
                let bestIdx = -1;

                for (let i = 0; i < jobberExps.length; i++) {
                    if (matchedJobber.has(i)) continue;

                    const jobber = jobberExps[i];
                    const diff = Math.abs(bank.amount - jobber.amount);

                    let score = 0;
                    if (diff < 0.01) score = 100;
                    else if (diff < 1) score = 80;
                    else if (diff < 5) score = 60;

                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = jobber;
                        bestIdx = i;
                    }
                }

                if (bestMatch && bestScore >= 80) {
                    matchedJobber.add(bestIdx);
                }

                results.push({
                    bank: bank,
                    match: bestMatch,
                    score: bestScore,
                    status: bestScore >= 100 ? 'exact' : bestScore >= 80 ? 'partial' : 'none'
                });
            }

            matchResults = results;
            populateFilterOptions();
            displayResults(results);
        }
        
        // Populate filter dropdowns
        function populateFilterOptions() {
            // Get unique employees from bank transactions
            const uniqueEmployees = [...new Set(bankTxns.map(t => t.cardholder).filter(Boolean))].sort();
            const empSelect = document.getElementById('filterEmployee');
            empSelect.innerHTML = '<option value="all">All Employees</option>' + 
                uniqueEmployees.map(e => `<option value="${e}">${e}</option>`).join('');
            
            // Get unique jobs from jobber expenses
            const uniqueJobs = [...new Set(jobberExps.map(j => j.job).filter(Boolean))].sort();
            const jobSelect = document.getElementById('filterJob');
            jobSelect.innerHTML = '<option value="all">All Jobs</option>' + 
                uniqueJobs.map(j => `<option value="${j}">${j}</option>`).join('');
        }

        // Display results
        function displayResults(results) {
            const matched = results.filter(r => r.status === 'exact').length;
            const partial = results.filter(r => r.status === 'partial').length;
            const missing = results.filter(r => r.status === 'none').length;

            document.getElementById('countMatched').textContent = matched;
            document.getElementById('countPartial').textContent = partial;
            document.getElementById('countMissing').textContent = missing;

            renderFilteredResults(results);
            
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Render filtered results
        function renderFilteredResults(results) {
            const container = document.getElementById('transactionsList');
            container.innerHTML = results.map(r => {
                const isMatched = r.status === 'exact';
                const isPartial = r.status === 'partial';
                const bgClass = isMatched ? 'bg-green-50 border-green-500' : 
                               isPartial ? 'bg-yellow-50 border-yellow-500' : 
                               'bg-red-50 border-red-500';
                const borderClass = isMatched ? 'border-green-500' : isPartial ? 'border-yellow-500' : 'border-red-500';
                
                // Find employee for SMS
                let emp = null;
                if (r.bank.cardholder && employees[r.bank.cardholder]) {
                    emp = employees[r.bank.cardholder];
                }

                let smsButton = '';
                if (!isMatched && emp && emp.phone) {
                    const msg = `Hi ${emp.name.split(' ')[0]}, I need a receipt for this company card transaction:\n\nMerchant: ${r.bank.merchant}\nAmount: $${r.bank.amount.toFixed(2)}\nDate: ${r.bank.date || 'N/A'}\n\nPlease submit through Jobber or reply with a photo of the receipt.\n\nThanks!`;
                    smsButton = `<a href="sms:${emp.phone}?body=${encodeURIComponent(msg)}" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 whitespace-nowrap"><i class="fas fa-comment-dots"></i> SMS</a>`;
                } else if (!isMatched) {
                    smsButton = `<span class="text-gray-400 text-xs">No phone</span>`;
                }

                const matchBadge = isMatched ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">✓ Matched</span>' : 
                                   isPartial ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">~ Close</span>' : 
                                   '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">✗ Missing</span>';

                return `
                    <div class="${bgClass} border-l-4 rounded-lg p-3 text-sm">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-semibold text-gray-900 truncate">${r.bank.merchant || 'Unknown'}</span>
                                    <span class="text-gray-600 font-medium">$${r.bank.amount.toFixed(2)}</span>
                                    ${matchBadge}
                                </div>
                                ${r.match ? `
                                    <div class="text-gray-600 mt-1 text-xs">
                                        → ${r.match.item} <span class="text-gray-500">($${r.match.amount.toFixed(2)})</span>
                                    </div>
                                ` : ''}
                                ${r.bank.cardholder ? `<div class="text-gray-400 text-xs mt-1">${r.bank.cardholder}</div>` : ''}
                            </div>
                            <div class="flex-shrink-0">
                                ${smsButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
